<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest AR Video Window</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            font-family: Arial, sans-serif;
            overflow: hidden; /* Prevent scrollbars */
        }
        #container {
            width: 100vw;
            height: 100vh;
            display: block; /* Ensure canvas fills the container */
        }
        #playButtonOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.75); /* Semi-transparent black overlay */
            z-index: 100; /* Ensure it's above the canvas */
        }
        #playButton {
            padding: 20px 40px;
            font-size: 24px;
            font-weight: bold;
            color: white;
            background-color: #4CAF50; /* Green button */
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        #playButton:hover {
            background-color: #45a049;
            transform: scale(1.05);
        }
        #playButton:active {
            transform: scale(0.98);
        }
        #instructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            z-index: 99; /* Below play button, above canvas */
            display: none; /* Hidden by default, shown after play */
        }
    </style>
</head>
<body>
    <div id="container"></div>

    <div id="playButtonOverlay">
        <button id="playButton">Play Video</button>
    </div>

    <div id="instructions">
        Use 'W' (forward) and 'S' (backward) keys to move.
        <br/>
        On touch devices, swipe up/down to move.
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer, arSession;
        let videoElement, videoTexture, videoScreen;
        let playButtonOverlay, playButton, instructionsDiv;

        // Camera movement speed
        const moveSpeed = 0.05;

        // Initialize Three.js scene
        function initScene() {
            // Scene setup
            scene = new THREE.Scene();

            // Camera setup
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5; // Initial global position of the camera

            // Renderer setup
            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true // Enable alpha for AR passthrough
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 0); // Transparent background for AR
            renderer.xr.enabled = true; // Enable WebXR on the renderer
            document.getElementById('container').appendChild(renderer.domElement);

            // Create the video screen
            createVideoScreen();

            // Store references to UI elements
            playButtonOverlay = document.getElementById('playButtonOverlay');
            playButton = document.getElementById('playButton');
            instructionsDiv = document.getElementById('instructions');

            // Add event listener for the play button
            playButton.addEventListener('click', handlePlayVideo);

            // Set up WebXR session (without starting it immediately)
            checkWebXRSupport();

            // Add keyboard and touch controls for camera movement
            setupMovementControls();
        }

        // Creates the 3D video screen and attaches it to the camera
        function createVideoScreen() {
            // 1. Video Element Setup
            videoElement = document.createElement('video');
            videoElement.src = 'https://www.learningcontainer.com/wp-content/uploads/2020/05/sample-mp4-file.mp4'; // Sample video URL
            videoElement.loop = true;
            videoElement.muted = true; // Muted by default for autoplay
            videoElement.playsInline = true; // Required for autoplay on iOS

            // 2. Video Texture and Material for the Screen
            videoTexture = new THREE.VideoTexture(videoElement);
            videoTexture.minFilter = THREE.LinearFilter;
            videoTexture.magFilter = THREE.LinearFilter;
            videoTexture.format = THREE.RGBAFormat;

            const screenMaterial = new THREE.MeshBasicMaterial({ map: videoTexture, side: THREE.DoubleSide });

            // 3. Screen Geometry (Plane) - Adjust size as needed
            const screenWidth = 2.0; // Example width in world units
            const screenHeight = screenWidth / (16 / 9); // Assuming 16:9 aspect ratio

            const screenGeometry = new THREE.PlaneGeometry(screenWidth, screenHeight);

            // 4. Create the Screen Mesh
            videoScreen = new THREE.Mesh(screenGeometry, screenMaterial);

            // 5. Position the screen in front of the camera, relative to its local space
            // This makes it "stationary" relative to the user's view
            videoScreen.position.set(0, 0, -3); // 3 units in front of the camera

            // 6. Add the screen as a child of the camera
            // This ensures the screen always stays centered in the user's view
            camera.add(videoScreen);
            scene.add(camera); // Add camera (which now contains the screen) to the scene
        }

        // Handles starting video playback
        function handlePlayVideo() {
            if (videoElement) {
                videoElement.play().then(() => {
                    // Hide the play button overlay after successful playback
                    playButtonOverlay.style.display = 'none';
                    instructionsDiv.style.display = 'block'; // Show instructions
                    console.log('Video started playing.');
                }).catch(error => {
                    console.error("Error playing video:", error);
                    alert("Video autoplay blocked. Please allow media playback in your browser settings or interact with the page.");
                });
            }
        }

        // Sets up keyboard and touch controls for camera movement
        function setupMovementControls() {
            // Keyboard controls
            const handleKeyDown = (event) => {
                switch (event.key) {
                    case 'w': // Move forward
                        camera.position.z -= moveSpeed;
                        break;
                    case 's': // Move backward
                        camera.position.z += moveSpeed;
                        break;
                    default:
                        break;
                }
            };
            window.addEventListener('keydown', handleKeyDown);

            // Touch controls (simple swipe up/down for forward/backward)
            let touchStartY = 0;
            const handleTouchStart = (event) => {
                if (event.touches.length > 0) {
                    touchStartY = event.touches[0].clientY;
                }
            };

            const handleTouchEnd = (event) => {
                if (event.changedTouches.length > 0) {
                    const touchEndY = event.changedTouches[0].clientY;
                    const deltaY = touchEndY - touchStartY;

                    if (deltaY < -50) { // Swipe up (move forward)
                        camera.position.z -= moveSpeed * 10; // Faster for touch
                    } else if (deltaY > 50) { // Swipe down (move backward)
                        camera.position.z += moveSpeed * 10; // Faster for touch
                    }
                }
            };

            window.addEventListener('touchstart', handleTouchStart);
            window.addEventListener('touchend', handleTouchEnd);
        }

        // Checks WebXR support and updates UI status
        async function checkWebXRSupport() {
            if (!navigator.xr) {
                console.warn('WebXR not available in this browser');
                // You might want to update a status message on the page here
                return;
            }

            try {
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                if (supported) {
                    // If AR is supported, start the AR session automatically or via a button
                    startARSession(); // Automatically start AR session
                } else {
                    console.warn('AR not supported on this device');
                }
            } catch (error) {
                console.error('Error checking AR support:', error);
            }
        }

        // Starts the immersive AR session
        async function startARSession() {
            try {
                arSession = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['local-floor'],
                    optionalFeatures: ['local', 'bounded-floor']
                });

                await renderer.xr.setSession(arSession);

                arSession.addEventListener('end', () => {
                    console.log('AR session ended.');
                    // Handle session end if needed, e.g., reset UI
                });

                // Start the render loop for AR
                renderer.setAnimationLoop(render);

            } catch (error) {
                console.error('AR session failed:', error);
                alert(`AR session failed: ${error.message}. Make sure your device supports WebXR AR.`);
            }
        }

        // Main render loop
        function render() {
            renderer.render(scene, camera);
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Initialize the scene when the page loads
        window.onload = initScene;
    </script>
</body>
</html>
